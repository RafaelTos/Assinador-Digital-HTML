<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assinador Digital</title>
    <!-- Carrega o Tailwind CSS para o estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Estilo para o "bloco" de assinatura */
      canvas {
        touch-action: none; /* Previne scroll da página ao desenhar no tablet */
        border: 2px dashed #cbd5e1;
        border-radius: 0.5rem;
        cursor: crosshair;
        background-color: #f8fafc;
      }
      /* Estilo para a imagem da assinatura na lista de consulta */
      .signature-image {
        border: 1px solid #e5e7eb;
        border-radius: 0.25rem;
        background-color: #ffffff;
      }
      /* Classe para mostrar/esconder abas */
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      /* Spinner para loading */
      .spinner {
        border-top-color: #3498db;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="bg-gray-100 font-sans">
    <!-- 
      NOVO: Modal de Seleção de Empresa
      Isso aparece primeiro, bloqueando o app até a seleção.
    -->
    <div
      id="empresa-modal"
      class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-75"
    >
      <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Bem-vindo(a)</h2>
        <p class="text-gray-600 mb-4">
          Para continuar, por favor, selecione a empresa:
        </p>
        <select
          id="empresa-modal-select"
          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white"
        >
          <option value="">Selecione a Empresa</option>
          <option value="empresa_a">Empresa A</option>
          <option value="empresa_b">Empresa B</option>
          <option value="empresa_c">Empresa C</option>
        </select>
        <div
          id="modal-message-box"
          class="text-red-600 text-sm mt-2 hidden"
        ></div>
        <button
          id="btn-continuar"
          class="w-full mt-6 px-6 py-3 bg-blue-600 text-white font-medium rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
        >
          Continuar
        </button>
      </div>
    </div>

    <!-- 
      Container principal 
      NOVO: Adicionado ID 'main-app-container' para aplicar o efeito de blur
    -->
    <div
      id="main-app-container"
      class="bg-gray-100 min-h-screen p-4 sm:p-8"
    >
      <!-- Card principal do aplicativo -->
      <div
        class="max-w-4xl mx-auto bg-white shadow-xl rounded-lg overflow-hidden"
      >
        <!-- Cabeçalho -->
        <header class="bg-gray-800 text-white p-6">
          <h1 class="text-2xl sm:text-3xl font-bold">
            Sistema de Assinatura Digital
          </h1>
          <p class="text-gray-300">
            Gestão de termos e assinaturas internas
          </p>
        </header>

        <!-- Navegação por Abas -->
        <nav class="flex border-b border-gray-200">
          <button
            id="btn-tab-assinar"
            onclick="showTab('assinar')"
            class="tab-button active flex-1 py-4 px-6 font-medium text-center focus:outline-none transition-colors duration-150 border-b-2 border-blue-600 text-blue-600"
          >
            Assinar Documento
          </button>
          <button
            id="btn-tab-consultar"
            onclick="showTab('consultar')"
            class="tab-button flex-1 py-4 px-6 font-medium text-center focus:outline-none transition-colors duration-150 text-gray-500 hover:text-gray-700"
          >
            Consultar Termos
          </button>
        </nav>

        <!-- Conteúdo das Abas -->
        <main class="p-6 sm:p-8">
          <!-- ABA: ASSINAR DOCUMENTO -->
          <section id="tab-assinar" class="tab-content active space-y-6">
            <h2 class="text-xl font-semibold text-gray-800">
              Novo Termo de Assinatura
            </h2>

            <!-- Formulário de Dados -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Empresa (agora pré-preenchido e desabilitado) -->
              <div>
                <label
                  for="empresa"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >Empresa</label
                >
                <select
                  id="empresa"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-gray-100"
                  disabled
                >
                  <option value="">Selecione a Empresa</option>
                  <option value="empresa_a">Empresa A</option>
                  <option value="empresa_b">Empresa B</option>
                  <option value="empresa_c">Empresa C</option>
                </select>
              </div>
              <!-- Departamento -->
              <div>
                <label
                  for="department"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >Departamento</label
                >
                <select
                  id="department"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white"
                >
                  <option value="dp">DP</option>
                  <option value="admissao">Admissão</option>
                  <option value="juridico">Jurídico</option>
                  <option value="comercial">Comercial</option>
                </select>
              </div>
              <!-- Nome Completo -->
              <div>
                <label
                  for="name"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >Nome Completo</label
                >
                <input
                  type="text"
                  id="name"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                  placeholder="Digite o nome completo"
                />
              </div>
              <!-- RE / RG / CPF -->
              <div>
                <label
                  for="documentId"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >RE / RG / CPF</label
                >
                <input
                  type="text"
                  id="documentId"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                  placeholder="Digite o documento"
                />
              </div>
              <!-- Email -->
              <div>
                <label
                  for="email"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >Email</label
                >
                <input
                  type="email"
                  id="email"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                  placeholder="Digite o email"
                />
              </div>
              <!-- Telefone -->
              <div>
                <label
                  for="telefone"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >Telefone (Opcional)</label
                >
                <input
                  type="tel"
                  id="telefone"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                  placeholder="Digite o telefone"
                />
              </div>
              <!-- Centro de Custos -->
              <div class="md:col-span-2">
                <label
                  for="centroCusto"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >Centro de Custos</label
                >
                <input
                  type="text"
                  id="centroCusto"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                  placeholder="Digite o centro de custos"
                />
              </div>
            </div>

            <!-- Bloco com Duas Assinaturas (Canvas) -->
            <div class="space-y-4">
              <!-- Assinatura do Colaborador -->
              <div>
                <label
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >Assinatura do Colaborador</label
                >
                <canvas
                  id="colaboradorCanvas"
                  class="w-full"
                  height="200"
                ></canvas>
              </div>
              <!-- Assinatura do Suporte -->
              <div>
                <label
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >Assinatura do Suporte</label
                >
                <canvas
                  id="suporteCanvas"
                  class="w-full"
                  height="200"
                ></canvas>
              </div>
            </div>

            <!-- Mensagens de Erro ou Sucesso -->
            <div
              id="message-box"
              class="border p-3 rounded-md text-sm hidden"
            ></div>

            <!-- Botões de Ação -->
            <div class="flex flex-col sm:flex-row gap-4">
              <button
                id="btn-save"
                class="w-full sm:w-auto flex-1 px-6 py-3 bg-blue-600 text-white font-medium rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors duration-150"
              >
                Salvar Assinatura
              </button>
              <button
                id="btn-clear"
                class="w-full sm:w-auto flex-1 px-6 py-3 bg-gray-200 text-gray-800 font-medium rounded-md shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition-colors duration-150"
              >
                Limpar Assinaturas
              </button>
            </div>
          </section>

          <!-- ABA: CONSULTAR TERMOS -->
          <section id="tab-consultar" class="tab-content">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">
              Termos Assinados
            </h2>

            <!-- Filtros -->
            <div class="flex gap-4 mb-4 flex-wrap">
              <select
                id="filter-department"
                class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white"
              >
                <option value="todos">Todos Departamentos</option>
                <option value="dp">DP</option>
                <option value="admissao">Admissão</option>
                <option value="juridico">Jurídico</option>
                <option value="comercial">Comercial</option>
              </select>
              <select
                id="filter-status"
                class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white"
              >
                <option value="todos">Todos Status</option>
                <option value="ativo">Ativos</option>
                <option value="desativado">Desativados</option>
              </select>
              <select
                id="filter-empresa"
                class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white"
              >
                <option value="todos">Todas Empresas</option>
                <option value="empresa_a">Empresa A</option>
                <option value="empresa_b">Empresa B</option>
                <option value="empresa_c">Empresa C</option>
              </select>
            </div>

            <!-- Lista de Assinaturas -->
            <div id="loading-state" class="text-center py-10 text-gray-500">
              Carregando termos...
            </div>
            <div id="empty-state" class="text-center py-10 text-gray-500 hidden">
              Nenhum termo encontrado com os filtros selecionados.
            </div>
            <div id="assinaturas-list" class="space-y-4">
              <!-- As assinaturas serão injetadas aqui pelo JavaScript -->
            </div>
          </section>
        </main>
      </div>

      <!-- Footer com ID (opcional, para debug) -->
      <footer class="text-center text-xs text-gray-500 mt-4">
        ID de Sessão: <span id="user-id-span">...</span>
      </footer>
    </div>

    <!--
    ================================================================
    SCRIPT DE LÓGICA DO APLICATIVO
    ================================================================
    -->
    <!-- Carrega os módulos do Firebase -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        addDoc,
        updateDoc,
        onSnapshot,
        collection,
        query,
        Timestamp,
        setLogLevel,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // =================================================================
      // PASSO 1: COLE A CONFIGURAÇÃO DO SEU FIREBASE AQUI
      // 1. Crie um projeto no firebase.google.com
      // 2. Clique em "Adicionar app" > "Web" (ícone </>)
      // 3. Copie o objeto 'firebaseConfig' e cole abaixo
      // =================================================================

      const SEU_FIREBASE_CONFIG = null;

      // =================================================================
      // FIM DO PASSO 1
      // =================================================================

      // =================================================================
      // PASSO 2: CAMINHO DO BANCO DE DADOS
      // Este é o "caminho" na nuvem onde os dados serão salvos.
      // Você deve configurar as Regras de Segurança no seu Firebase.
      //
      // Regras (Cole isso na aba 'Regras' do seu Firestore):
      /*
      rules_version = '2';
      service cloud.firestore {
        match /databases/{database}/documents {
          // Permite que usuários anonimamente logados leiam e escrevam
          match /assinaturas/meu-app-assinatura/termos/{termoId} {
            allow read, write: if request.auth != null;
          }
        }
      }
      */
      // =================================================================

      const COLLECTION_PATH = "/assinaturas/meu-app-assinatura/termos";

      // --- Variáveis Globais do App ---
      let app, auth, db;
      let userId = null;
      let allAssinaturas = []; // Cache de todos os termos
      let unsubscribeFirestore = null; // Função para parar de ouvir o DB

      // --- Elementos do DOM ---
      const messageBox = document.getElementById("message-box");
      const btnSave = document.getElementById("btn-save");
      const btnClear = document.getElementById("btn-clear");
      const userIdSpan = document.getElementById("user-id-span");

      // Campos do Formulário
      const inputName = document.getElementById("name");
      const inputDocId = document.getElementById("documentId");
      const inputEmail = document.getElementById("email");
      const inputTelefone = document.getElementById("telefone");
      const selectEmpresa = document.getElementById("empresa");
      const selectDepartment = document.getElementById("department");
      const inputCentroCusto = document.getElementById("centroCusto");

      // Abas
      const tabAssinar = document.getElementById("tab-assinar");
      const tabConsultar = document.getElementById("tab-consultar");
      const btnTabAssinar = document.getElementById("btn-tab-assinar");
      const btnTabConsultar = document.getElementById("btn-tab-consultar");

      // Consulta
      const listContainer = document.getElementById("assinaturas-list");
      const loadingState = document.getElementById("loading-state");
      const emptyState = document.getElementById("empty-state");
      const filterDept = document.getElementById("filter-department");
      const filterStatus = document.getElementById("filter-status");
      const filterEmpresa = document.getElementById("filter-empresa");

      // NOVO: Elementos do Modal
      const empresaModal = document.getElementById("empresa-modal");
      const empresaModalSelect = document.getElementById(
        "empresa-modal-select"
      );
      const btnContinuar = document.getElementById("btn-continuar");
      const modalMessageBox = document.getElementById("modal-message-box");
      const mainAppContainer = document.getElementById("main-app-container");

      // --- Funções Auxiliares ---

      /**
       * Mostra ou esconde as abas
       */
      window.showTab = (tabName) => {
        if (tabName === "assinar") {
          tabAssinar.classList.add("active");
          tabConsultar.classList.remove("active");
          btnTabAssinar.classList.add(
            "border-blue-600",
            "text-blue-600"
          );
          btnTabAssinar.classList.remove("text-gray-500", "hover:text-gray-700");
          btnTabConsultar.classList.remove(
            "border-blue-600",
            "text-blue-600"
          );
          btnTabConsultar.classList.add(
            "text-gray-500",
            "hover:text-gray-700"
          );
        } else {
          tabAssinar.classList.remove("active");
          tabConsultar.classList.add("active");
          btnTabConsultar.classList.add(
            "border-blue-600",
            "text-blue-600"
          );
          btnTabConsultar.classList.remove(
            "text-gray-500",
            "hover:text-gray-700"
          );
          btnTabAssinar.classList.remove(
            "border-blue-600",
            "text-blue-600"
          );
          btnTabAssinar.classList.add("text-gray-500", "hover:text-gray-700");
        }
      };

      /**
       * Mostra uma mensagem de feedback (sucesso ou erro)
       */
      function showMessage(message, type = "error") {
        messageBox.classList.remove("hidden", "bg-red-100", "bg-green-100");
        if (type === "error") {
          messageBox.classList.add(
            "bg-red-100",
            "border-red-300",
            "text-red-800"
          );
        } else {
          messageBox.classList.add(
            "bg-green-100",
            "border-green-300",
            "text-green-800"
          );
        }
        messageBox.textContent = message;
      }

      function hideMessage() {
        messageBox.classList.add("hidden");
      }

      /**
       * Limpa o formulário e os canvases
       */
      function resetForm() {
        inputName.value = "";
        inputDocId.value = "";
        inputEmail.value = "";
        inputTelefone.value = "";
        // Não limpa a empresa, pois ela foi selecionada no início
        // selectEmpresa.value = "";
        selectDepartment.value = "dp";
        inputCentroCusto.value = "";
        canvasColaborador.clear();
        canvasSuporte.clear();
        hideMessage();
      }

      // --- Lógica do Canvas de Assinatura ---
      // Esta classe gerencia um único canvas
      class SignatureCanvas {
        constructor(canvasId) {
          this.canvas = document.getElementById(canvasId);
          if (!this.canvas) {
            console.error(`Canvas com ID ${canvasId} não encontrado.`);
            return;
          }
          this.ctx = this.canvas.getContext("2d");
          this.isDrawing = false;
          this.blankDataUrl = null; // Armazena a imagem em branco

          this.init();
        }

        init() {
          // Ajusta o tamanho do canvas para o tamanho real na tela
          this.canvas.width = this.canvas.offsetWidth;
          this.canvas.height = this.canvas.offsetHeight;

          this.ctx.strokeStyle = "#000000";
          this.ctx.lineWidth = 2;
          this.ctx.lineCap = "round";
          this.ctx.lineJoin = "round";

          // Armazena a imagem em branco para validação
          this.blankDataUrl = this.canvas.toDataURL("image/png");

          // Eventos de Mouse
          this.canvas.addEventListener("mousedown", (e) => this.startDrawing(e));
          this.canvas.addEventListener("mousemove", (e) => this.draw(e));
          this.canvas.addEventListener("mouseup", () => this.stopDrawing());
          this.canvas.addEventListener("mouseout", () => this.stopDrawing());

          // Eventos de Toque (para tablets)
          this.canvas.addEventListener(
            "touchstart",
            (e) => this.startDrawing(e)
          );
          this.canvas.addEventListener("touchmove", (e) => this.draw(e));
          this.canvas.addEventListener("touchend", () => this.stopDrawing());
        }

        getCoords(e) {
          e.preventDefault();
          const rect = this.canvas.getBoundingClientRect();
          let event = e;

          if (window.TouchEvent && e instanceof TouchEvent) {
            event = e.changedTouches[0] || e.touches[0];
          }

          return {
            x: event.clientX - rect.left,
            y: event.clientY - rect.top,
          };
        }

        startDrawing(e) {
          const { x, y } = this.getCoords(e);
          this.isDrawing = true;
          this.ctx.beginPath();
          this.ctx.moveTo(x, y);
        }

        draw(e) {
          if (!this.isDrawing) return;
          const { x, y } = this.getCoords(e);
          this.ctx.lineTo(x, y);
          this.ctx.stroke();
        }

        stopDrawing() {
          this.isDrawing = false;
          this.ctx.beginPath();
        }

        clear() {
          this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        }

        getDataURL() {
          return this.canvas.toDataURL("image/png");
        }

        // Verifica se o canvas está em branco
        isBlank() {
          return this.getDataURL() === this.blankDataUrl;
        }
      }

      // Inicializa os dois canvases
      let canvasColaborador, canvasSuporte;

      // --- Lógica do Firebase ---

      /**
       * 1. Inicializa o Firebase e a Autenticação
       */
      function initializeAppAndAuth() {
        if (!SEU_FIREBASE_CONFIG) {
          showMessage(
            "Erro Crítico: A configuração do Firebase não foi definida. Edite o arquivo .html e cole sua 'firebaseConfig' na variável 'SEU_FIREBASE_CONFIG'."
          );
          console.error(
            "SEU_FIREBASE_CONFIG não está definida. O app não pode funcionar."
          );
          // NOVO: Esconde o modal e mostra o erro principal
          empresaModal.style.display = "none";
          mainAppContainer.style.filter = "none";
          return;
        }

        try {
          app = initializeApp(SEU_FIREBASE_CONFIG);
          auth = getAuth(app);
          db = getFirestore(app);
          setLogLevel("debug"); // Mostra logs detalhados do Firebase no console

          // Adiciona o listener de autenticação
          onAuthStateChanged(auth, async (user) => {
            if (user) {
              // Usuário está logado (anonimamente)
              userId = user.uid;
              userIdSpan.textContent = userId;
              console.log("Logado com UID:", userId);

              // Só agora podemos inicializar os listeners do Firestore
              setupFirestoreListener();
            } else {
              // Usuário não está logado, tenta logar
              console.log("Usuário não logado, tentando login anônimo...");
              userId = null;
              userIdSpan.textContent = "Autenticando...";
              if (unsubscribeFirestore) unsubscribeFirestore(); // Para de ouvir o DB

              try {
                // CORREÇÃO: Usamos apenas signInAnonymously.
                // Não há __initial_auth_token neste modo simples.
                await signInAnonymously(auth);
              } catch (error) {
                console.error("Erro no login anônimo:", error);
                showMessage(
                  "Erro de autenticação. Verifique as regras do Firebase."
                );
              }
            }
          });
        } catch (error) {
          console.error("Erro ao inicializar o Firebase:", error);
          showMessage(
            "Erro ao inicializar o Firebase. Verifique sua 'firebaseConfig'."
          );
          // NOVO: Esconde o modal e mostra o erro principal
          empresaModal.style.display = "none";
          mainAppContainer.style.filter = "none";
        }
      }

      /**
       * 2. Ouve as mudanças no Firestore (em tempo real)
       */
      function setupFirestoreListener() {
        if (unsubscribeFirestore) {
          unsubscribeFirestore(); // Para o listener anterior se existir
        }

        if (!db || !COLLECTION_PATH) return;

        console.log("Configurando listener do Firestore para:", COLLECTION_PATH);
        loadingState.style.display = "block";
        emptyState.style.display = "none";
        listContainer.innerHTML = "";

        const q = query(collection(db, COLLECTION_PATH));

        unsubscribeFirestore = onSnapshot(
          q,
          (snapshot) => {
            console.log("Dados recebidos:", snapshot.docs.length);
            allAssinaturas = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            // Ordena os mais novos primeiro
            allAssinaturas.sort(
              (a, b) => b.createdAt.toDate() - a.createdAt.toDate()
            );

            renderAssinaturas(); // Atualiza a lista na tela
          },
          (error) => {
            console.error("Erro ao ouvir Firestore:", error);
            showMessage("Erro ao carregar dados. Verifique a conexão.");
            loadingState.style.display = "none";
          }
        );
      }

      /**
       * 3. Renderiza a lista de assinaturas na tela
       */
      function renderAssinaturas() {
        const dept = filterDept.value;
        const status = filterStatus.value;
        const empresa = filterEmpresa.value;

        const filteredList = allAssinaturas.filter((a) => {
          const deptMatch = dept === "todos" || a.department === dept;
          const statusMatch = status === "todos" || a.status === status;
          const empresaMatch = empresa === "todos" || a.empresa === empresa;
          return deptMatch && statusMatch && empresaMatch;
        });

        listContainer.innerHTML = ""; // Limpa a lista
        loadingState.style.display = "none";

        if (filteredList.length === 0) {
          emptyState.style.display = "block";
        } else {
          emptyState.style.display = "none";
          filteredList.forEach((assinatura) => {
            const date = assinatura.createdAt.toDate().toLocaleString("pt-BR", {
              day: "2-digit",
              month: "2-digit",
              year: "numeric",
              hour: "2-digit",
              minute: "2-digit",
            });

            const statusClass =
              assinatura.status === "ativo"
                ? "bg-green-100 text-green-800"
                : "bg-gray-100 text-gray-800";

            const empresaLabel = assinatura.empresa.replace("_", " ");

            // HTML para o card do termo
            const cardHtml = `
              <div class="border border-gray-200 rounded-lg p-4 flex flex-col sm:flex-row gap-4">
                <!-- Coluna de Informações -->
                <div class="flex-1 space-y-2">
                  <h3 class="text-lg font-semibold text-gray-900">${
                    assinatura.name
                  }</h3>
                  <p class="text-sm text-gray-600"><strong>Doc:</strong> ${
                    assinatura.documentId
                  }</p>
                  <p class="text-sm text-gray-600"><strong>Email:</strong> ${
                    assinatura.email || "N/A"
                  }</p>
                  <p class="text-sm text-gray-600"><strong>Telefone:</strong> ${
                    assinatura.telefone || "N/A"
                  }</p>
                  <p class="text-sm text-gray-600"><strong>Centro de Custo:</strong> ${
                    assinatura.centroCusto || "N/A"
                  }</p>
                  <p class="text-sm text-gray-600"><strong>Data:</strong> ${date}</p>
                  <div class="flex items-center gap-4 flex-wrap">
                    <span class="text-xs font-medium capitalize px-2.5 py-0.5 rounded-full bg-gray-200 text-gray-800">${empresaLabel}</span>
                    <span class="text-xs font-medium uppercase px-2.5 py-0.5 rounded-full bg-blue-100 text-blue-800">${
                      assinatura.department
                    }</span>
                    <span class="text-xs font-medium capitalize px-2.5 py-0.5 rounded-full ${statusClass}">${
              assinatura.status
            }</span>
                  </div>
                </div>

                <!-- Coluna das Assinaturas e Ação -->
                <div class="flex flex-col items-center sm:items-end gap-2 sm:w-1/3">
                  <div>
                    <label class="text-xs font-medium text-gray-500">Ass. Colaborador</label>
                    <img src="${
                      assinatura.colaboradorSignatureDataUrl
                    }" alt="Assinatura Colaborador" class="signature-image w-full h-auto max-w-[200px]" />
                  </div>
                  <div class="mt-2">
                    <label class="text-xs font-medium text-gray-500">Ass. Suporte</label>
                    <img src="${
                      assinatura.suporteSignatureDataUrl
                    }" alt="Assinatura Suporte" class="signature-image w-full h-auto max-w-[200px]" />
                  </div>
                  ${
                    assinatura.status === "ativo"
                      ? `<button 
                            data-id="${assinatura.id}" 
                            class="btn-deactivate mt-2 px-4 py-2 text-sm font-medium text-red-700 bg-red-100 rounded-md hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 w-full max-w-[200px]"
                          >
                            Desativar Termo
                          </button>`
                      : ""
                  }
                </div>
              </div>
            `;
            listContainer.insertAdjacentHTML("beforeend", cardHtml);
          });
        }
      }

      /**
       * 4. Salva a assinatura no Firestore
       */
      async function saveSignature() {
        // Validação dos campos de texto
        const formData = {
          name: inputName.value,
          documentId: inputDocId.value,
          email: inputEmail.value,
          telefone: inputTelefone.value,
          empresa: selectEmpresa.value, // Já está preenchido
          department: selectDepartment.value,
          centroCusto: inputCentroCusto.value,
        };

        if (
          !formData.name ||
          !formData.documentId ||
          !formData.email ||
          !formData.empresa || // Validação extra
          !formData.centroCusto
        ) {
          showMessage(
            "Nome, Documento, Email, Empresa e Centro de Custos são obrigatórios."
          );
          return;
        }

        // Validação dos campos de assinatura
        if (canvasColaborador.isBlank() || canvasSuporte.isBlank()) {
          showMessage(
            "As assinaturas do colaborador e do suporte são obrigatórias."
          );
          return;
        }

        btnSave.disabled = true;
        btnSave.innerHTML = `<div class="spinner h-5 w-5 border-t-2 border-white rounded-full mx-auto"></div>`;
        hideMessage();

        try {
          const docData = {
            ...formData,
            colaboradorSignatureDataUrl: canvasColaborador.getDataURL(),
            suporteSignatureDataUrl: canvasSuporte.getDataURL(),
            status: "ativo",
            createdAt: Timestamp.now(), // Data/hora do servidor
          };

          await addDoc(collection(db, COLLECTION_PATH), docData);

          showMessage("Assinatura salva com sucesso!", "success");
          resetForm();
        } catch (error) {
          console.error("Erro ao salvar no Firestore:", error);
          showMessage("Erro ao salvar a assinatura. Tente novamente.");
        } finally {
          btnSave.disabled = false;
          btnSave.textContent = "Salvar Assinatura";
        }
      }

      /**
       * 5. Desativa um termo (muda o status)
       */
      async function deactivateSignature(id) {
        if (!db || !COLLECTION_PATH) return;

        try {
          const docRef = doc(db, COLLECTION_PATH, id);
          await updateDoc(docRef, {
            status: "desativado",
          });
          // A lista irá se atualizar sozinha graças ao onSnapshot
        } catch (error) {
          console.error("Erro ao desativar:", error);
          showMessage("Erro ao desativar o termo.");
        }
      }

      // --- Inicialização do Aplicativo ---
      // Garante que o DOM está pronto
      document.addEventListener("DOMContentLoaded", () => {
        // NOVO: Deixa o app principal borrado
        mainAppContainer.style.filter = "blur(5px)";

        // NOVO: Listener para o botão do modal
        btnContinuar.addEventListener("click", () => {
          const selectedEmpresa = empresaModalSelect.value;
          if (!selectedEmpresa) {
            modalMessageBox.textContent = "Por favor, selecione uma empresa.";
            modalMessageBox.classList.remove("hidden");
            return;
          }

          // Preencher o campo no formulário principal e desabilitá-lo
          selectEmpresa.value = selectedEmpresa;
          selectEmpresa.disabled = true; // Desabilita para não mudarem

          // Esconder o modal e remover o blur
          empresaModal.style.display = "none";
          mainAppContainer.style.filter = "none";

          // Inicia o Firebase DEPOIS que o modal for fechado
          initializeAppAndAuth();
        });

        // Inicializa os canvases DEPOIS que a página carregar
        canvasColaborador = new SignatureCanvas("colaboradorCanvas");
        canvasSuporte = new SignatureCanvas("suporteCanvas");

        // Adiciona os listeners dos botões
        btnSave.addEventListener("click", saveSignature);
        btnClear.addEventListener("click", resetForm);

        // Adiciona listeners dos filtros
        filterDept.addEventListener("change", renderAssinaturas);
        filterStatus.addEventListener("change", renderAssinaturas);
        filterEmpresa.addEventListener("change", renderAssinaturas);

        // Adiciona listener para botões de desativar (delegação de evento)
        listContainer.addEventListener("click", (e) => {
          if (e.target && e.target.classList.contains("btn-deactivate")) {
            const id = e.target.getAttribute("data-id");
            if (id) {
              deactivateSignature(id);
            }
          }
        });

        // NOTA: initializeAppAndAuth() foi movido para o listener do
        // botão 'btn-continuar' para garantir que o Firebase só
        // conecte após a seleção da empresa.
      });
    </script>
  </body>
</html>