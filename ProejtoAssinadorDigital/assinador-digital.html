<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assinador Digital</title>
    <!-- Carrega Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Estilos para o canvas de assinatura */
      .signature-canvas {
        border: 2px dashed #ccc;
        cursor: crosshair;
        background-color: #fff;
        touch-action: none; /* Desabilita o scroll do touch no canvas */
      }
      /* Estilo para a tab ativa */
      .tab-button.active {
        border-color: #3b82f6;
        color: #3b82f6;
        background-color: #f9fafb; /* Fundo leve para destaque */
      }
      /* Estilo para a sub-tab ativa (Ativos/Desativados) */
      .sub-tab-button.active {
          background-color: #3b82f6;
          color: white;
          border-color: #3b82f6;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      /* Estilos para a lista de termos */
      .term-item {
        border-left: 5px solid #3b82f6;
      }
      .term-item.inactive {
        border-left: 5px solid #ef4444; /* Cor vermelha para desativados */
      }
      /* Estilo para o modal de assinatura, para garantir que apare√ßa acima de tudo */
      #signature-detail-modal {
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
      }
      #signature-detail-modal.active {
        opacity: 1;
        visibility: visible;
      }
    </style>
  </head>
  <body class="bg-gray-100 font-sans">
    <!-- Modal de Sele√ß√£o de Empresa (In√≠cio) -->
    <div
      id="empresa-modal"
      class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-75"
    >
      <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300 scale-100">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">üëã Bem-vindo(a)</h2>
        <p class="text-gray-600 mb-6 text-center">
          Para iniciar, por favor, selecione a empresa:
        </p>
        <select
          id="empresa-modal-select"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-700"
        >
          <option value="">Selecione a Empresa</option>
          <option value="empresa_a">Empresa Alfa</option>
          <option value="empresa_b">Empresa Beta</option>
          <option value="empresa_c">Empresa Gama</option>
        </select>
        <div
          id="modal-message-box"
          class="text-red-600 text-sm mt-3 p-2 bg-red-100 border border-red-400 rounded-md hidden"
        ></div>
        <button
          id="btn-continuar"
          class="w-full mt-6 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 transition-colors duration-150"
        >
          Continuar
        </button>
      </div>
    </div>
    <!-- Modal de Sele√ß√£o de Empresa (Fim) -->

    <div
      id="main-app-container"
      class="bg-gray-100 min-h-screen p-4 sm:p-8"
      style="display: none;"
    >
      <div
        class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl overflow-hidden"
      >
        <header class="bg-gray-800 text-white p-6 rounded-t-xl">
          <h1 class="text-2xl sm:text-3xl font-bold flex items-center">
            üìÑ Sistema de Assinatura Digital
          </h1>
          <p class="text-gray-400 text-sm">Empresa Ativa: <span id="current-empresa-name" class="font-medium text-blue-300"></span></p>
        </header>

        <!-- Navega√ß√£o por Abas Principais -->
        <nav class="flex border-b border-gray-200 bg-gray-50">
          <button
            id="btn-tab-assinar"
            data-tab="assinar"
            class="tab-button active flex-1 py-4 px-6 font-semibold text-center focus:outline-none transition-colors duration-200 border-b-2"
          >
            ‚úçÔ∏è Assinar Documento
          </button>
          <button
            id="btn-tab-consultar"
            data-tab="consultar"
            class="tab-button flex-1 py-4 px-6 font-semibold text-center focus:outline-none transition-colors duration-200 text-gray-600 hover:text-gray-800 hover:bg-gray-100"
          >
            üìÇ Consultar Termos
          </button>
        </nav>

        <main class="p-6 sm:p-8">
          <!-- Se√ß√£o de Assinatura -->
          <section id="tab-assinar" class="tab-content active space-y-6">
            <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2 mb-4">
              Novo Termo de Assinatura
            </h2>

            <!-- Formul√°rio de Assinatura -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label
                  for="empresa"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >Empresa</label
                >
                <select
                  id="empresa"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm bg-gray-100 cursor-not-allowed"
                  disabled
                >
                  <option value="">Carregando...</option>
                </select>
              </div>
              <div>
                <label
                  for="department"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >Departamento</label
                >
                <select
                  id="department"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white"
                >
                  <option value="dp">DP (Departamento Pessoal)</option>
                  <option value="admissao">Admiss√£o</option>
                  <option value="juridico">Jur√≠dico</option>
                  <option value="comercial">Comercial</option>
                </select>
              </div>
              <div>
                <label
                  for="name"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >Nome Completo</label
                >
                <input
                  type="text"
                  id="name"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                  placeholder="Digite o nome completo do colaborador"
                />
              </div>
              <div>
                <label
                  for="documentId"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >RE / RG / CPF</label
                >
                <input
                  type="text"
                  id="documentId"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                  placeholder="Ex: 123.456.789-00"
                />
              </div>
              <div>
                <label
                  for="email"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >Email</label
                >
                <input
                  type="email"
                  id="email"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                  placeholder="Digite o email"
                />
              </div>
              <div>
                <label
                  for="telefone"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >Telefone (Opcional)</label
                >
                <input
                  type="tel"
                  id="telefone"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                  placeholder="Ex: (99) 99999-9999"
                />
              </div>
              <div class="md:col-span-2">
                <label
                  for="centroCusto"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >Centro de Custos</label
                >
                <input
                  type="text"
                  id="centroCusto"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                  placeholder="Digite o centro de custos"
                />
              </div>
            </div>
            
            <!-- Novos campos: Tipo de Termo e Conte√∫do do Termo -->
            <div class="md:col-span-2 space-y-4 pt-4">
              <label for="termType" class="block text-sm font-medium text-gray-700 mb-1"
                >Tipo de Termo a Assinar</label
              >
              <select
                id="termType"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white"
              >
                <option value="">Selecione o Tipo de Termo</option>
                <option value="emprestimo">Termo de Empr√©stimo de Equipamentos</option>
                <option value="uso">Termo de Uso e Pol√≠ticas de Seguran√ßa</option>
              </select>

              <!-- √Årea de Exibi√ß√£o do Termo -->
              <div id="term-content-display" class="bg-gray-50 border border-gray-300 p-4 rounded-lg h-60 overflow-y-auto text-sm text-gray-700">
                Selecione um tipo de termo acima para visualizar o conte√∫do.
              </div>
              
              <div class="flex items-start">
                <input type="checkbox" id="term-agreement" class="mt-1 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                <label for="term-agreement" class="ml-2 block text-sm text-gray-800 select-none cursor-pointer">
                  Declaro que li e concordo com os termos acima.
                </label>
              </div>
            </div>
            <!-- Fim dos Novos campos -->

            <!-- √Åreas de Assinatura -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4">
              <div>
                <label
                  class="block text-sm font-medium text-gray-700 mb-2"
                  >Assinatura do Colaborador (Desenhe aqui)</label
                >
                <canvas
                  id="colaboradorCanvas"
                  class="signature-canvas w-full rounded-lg"
                  height="150"
                ></canvas>
              </div>
              <div>
                <label
                  class="block text-sm font-medium text-gray-700 mb-2"
                  >Assinatura do Suporte (Desenhe aqui)</label
                >
                <canvas
                  id="suporteCanvas"
                  class="signature-canvas w-full rounded-lg"
                  height="150"
                ></canvas>
              </div>
            </div>

            <!-- Caixa de Mensagens (Assinar) -->
            <div
              id="message-box"
              class="p-4 rounded-lg text-sm hidden transition-all duration-300"
            ></div>

            <!-- Bot√µes de A√ß√£o -->
            <div class="flex flex-col sm:flex-row gap-4 pt-4">
              <button
                id="btn-save"
                class="w-full sm:w-auto flex-1 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors duration-150"
              >
                Salvar Assinatura Digital
              </button>
              <button
                id="btn-clear"
                class="w-full sm:w-auto flex-1 px-6 py-3 bg-gray-200 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-300 focus:outline-none focus:ring-4 focus:ring-gray-400 focus:ring-opacity-50 transition-colors duration-150"
              >
                Limpar Assinaturas
              </button>
            </div>
          </section>

          <!-- Se√ß√£o de Consulta -->
          <section id="tab-consultar" class="tab-content space-y-6">
            <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2 mb-4">
              Termos Assinados
            </h2>
            
            <!-- SUB-ABAS ATIVOS/DESATIVADOS -->
            <div class="flex border-b border-gray-200">
                <button
                    id="btn-status-ativo"
                    data-status="ativo"
                    class="sub-tab-button active px-6 py-2 font-semibold rounded-t-lg border-b-2 border-transparent hover:border-blue-500 hover:text-blue-600 transition-colors duration-150"
                >
                    ‚úÖ Ativos
                </button>
                <button
                    id="btn-status-desativado"
                    data-status="desativado"
                    class="sub-tab-button px-6 py-2 font-semibold text-gray-600 rounded-t-lg border-b-2 border-transparent hover:border-red-500 hover:text-red-600 transition-colors duration-150"
                >
                    ‚ùå Desativados
                </button>
            </div>
            <!-- FIM SUB-ABAS -->

            <!-- Filtros e Busca -->
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 pt-4">
              <!-- Barra de Pesquisa -->
              <div class="sm:col-span-2">
                <label
                  for="search-term"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >Buscar por Nome/Documento</label
                >
                <input
                  type="text"
                  id="search-term"
                  placeholder="Ex: Jo√£o Silva ou 123.456"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                />
              </div>

              <!-- Filtro de Departamento -->
              <div>
                <label
                  for="filter-department"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >Departamento</label
                >
                <select
                  id="filter-department"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white"
                >
                  <option value="todos">Todos</option>
                  <option value="dp">DP</option>
                  <option value="admissao">Admiss√£o</option>
                  <option value="juridico">Jur√≠dico</option>
                  <option value="comercial">Comercial</option>
                </select>
              </div>
              
              <!-- Filtro de Empresa (Apenas para Leitura) -->
              <div>
                <label
                  for="filter-empresa"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >Empresa</label
                >
                <select
                  id="filter-empresa"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm bg-gray-100 cursor-not-allowed"
                  disabled
                >
                  <option value="todos">Empresa Atual</option>
                </select>
              </div>
            </div>
            
            <div id="loading-state" class="text-center py-10 text-blue-600 font-semibold text-lg hidden">
              <!-- Estado de Carregamento (Oculto, pois n√£o h√° carregamento ass√≠ncrono) -->
            </div>
            <div id="empty-state" class="text-center py-10 text-gray-500 hidden">
              <p class="text-xl mb-2">Nenhum termo encontrado ü§∑</p>
              <p>Altere os filtros ou adicione uma nova assinatura.</p>
            </div>
            <div id="assinaturas-list" class="space-y-4">
            </div>
          </section>
        </main>
      </div>

      <footer class="text-center text-xs text-gray-500 mt-6">
        Dados salvos localmente no seu navegador (Local Storage).
      </footer>
    </div>

    <!-- Script JavaScript -->
    <script>
      // ----------------------------------------------------
      // 1. CONFIGURA√á√ÉO INICIAL E VARI√ÅVEIS GLOBAIS
      // ----------------------------------------------------
      
      let currentEmpresa = null;
      let currentViewStatus = 'ativo'; // Novo estado para as sub-abas
      const LOCAL_STORAGE_KEY = 'assinaturas_digitais';

      const EMPRESA_MAP = {
        'empresa_a': 'Empresa Alfa',
        'empresa_b': 'Empresa Beta',
        'empresa_c': 'Empresa Gama'
      };

      // Mapeamento de Departamentos para exibi√ß√£o
      const DEPARTMENT_MAP = {
        'dp': 'DP',
        'admissao': 'Admiss√£o',
        'juridico': 'Jur√≠dico',
        'comercial': 'Comercial'
      };
      
      // Mapeamento de Tipos de Termo para exibi√ß√£o
      const TERM_MAP = {
        'emprestimo': 'Empr√©stimo',
        'uso': 'Uso',
      };
      
      // Conte√∫do dos Termos (Hardcoded para demonstra√ß√£o sem backend)
      const TERMS_CONTENT = {
        'emprestimo': `
            <h4 class="font-bold mb-2">TERMO DE EMPR√âSTIMO DE EQUIPAMENTOS</h4>
            <p class="mb-3">Eu, [Nome do Colaborador], portador do documento [RE/RG/CPF], declaro ter recebido da [Empresa Ativa] os seguintes equipamentos em regime de comodato para uso exclusivo em minhas atividades laborais, comprometendo-me a zelar por sua integridade e conserva√ß√£o:</p>
            <ul class="list-disc list-inside ml-4 mb-3">
                <li>Notebook (Modelo: XXX, S√©rie: YYY)</li>
                <li>Mouse e Teclado (Modelo: ZZZ)</li>
                <li>Monitor (Modelo: AAA)</li>
            </ul>
            <p>O presente Termo de Empr√©stimo √© v√°lido durante todo o per√≠odo do v√≠nculo empregat√≠cio e dever√° ser devolvido imediatamente em caso de rescis√£o ou solicita√ß√£o da empresa. A n√£o devolu√ß√£o ou devolu√ß√£o em estado inadequado implicar√° em ressarcimento financeiro.</p>
        `,
        'uso': `
            <h4 class="font-bold mb-2">TERMO DE USO DE SOFTWARES E POL√çTICAS DE SEGURAN√áA</h4>
            <p class="mb-3">Eu, [Nome do Colaborador], concordo em cumprir integralmente todas as pol√≠ticas de seguran√ßa da informa√ß√£o e uso de softwares da [Empresa Ativa], incluindo, mas n√£o se limitando a:</p>
            <ul class="list-disc list-inside ml-4 mb-3">
                <li>N√£o compartilhar credenciais de acesso.</li>
                <li>Utilizar softwares e licen√ßas apenas para fins corporativos.</li>
                <li>Proteger informa√ß√µes confidenciais contra acesso n√£o autorizado.</li>
                <li>Realizar backups conforme orienta√ß√£o do departamento de TI.</li>
            </ul>
            <p>O uso inadequado dos recursos de TI pode resultar em medidas disciplinares, conforme previsto no C√≥digo de Conduta da empresa.</p>
        `
      };

      // ----------------------------------------------------
      // 2. FUN√á√ïES DE UTILIDADE (UI)
      // ----------------------------------------------------

      function displayMessage(message, isError = false, targetId = 'message-box') {
        const box = document.getElementById(targetId);
        if (!box) return;

        box.textContent = message;
        box.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'border-red-400', 'bg-green-100', 'text-green-700', 'border-green-400');

        if (isError) {
          box.classList.add('bg-red-100', 'text-red-700', 'border', 'border-red-400');
        } else {
          box.classList.add('bg-green-100', 'text-green-700', 'border', 'border-green-400');
        }
        
        // Esconde a mensagem ap√≥s 5 segundos
        setTimeout(() => box.classList.add('hidden'), 5000);
      }

      function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        document.getElementById(`tab-${tabId}`).classList.add('active');

        document.querySelectorAll('.tab-button').forEach(button => {
          button.classList.remove('active', 'border-blue-600', 'text-blue-600', 'bg-gray-50');
          button.classList.add('text-gray-600', 'hover:text-gray-800', 'hover:bg-gray-100');
        });
        const activeBtn = document.getElementById(`btn-tab-${tabId}`);
        activeBtn.classList.add('active', 'border-blue-600', 'text-blue-600', 'bg-gray-50');
        activeBtn.classList.remove('text-gray-600', 'hover:text-gray-800', 'hover:bg-gray-100');

        if (tabId === 'consultar') {
            loadAndFilterAssinaturas();
        }
      }
      
      // Nova fun√ß√£o para alternar entre Ativos e Desativados
      function switchStatusView(status) {
          currentViewStatus = status;
          document.querySelectorAll('.sub-tab-button').forEach(button => {
              button.classList.remove('active');
              button.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
              button.classList.add('text-gray-600');
          });
          const activeBtn = document.getElementById(`btn-status-${status}`);
          activeBtn.classList.add('active', 'bg-blue-600', 'text-white', 'border-blue-600');
          activeBtn.classList.remove('text-gray-600');
          
          loadAndFilterAssinaturas(); // Recarrega a lista com o novo filtro
      }

      function updateTermContent() {
        const termType = document.getElementById('termType').value;
        const displayDiv = document.getElementById('term-content-display');
        
        if (termType && TERMS_CONTENT[termType]) {
            let content = TERMS_CONTENT[termType];
            
            // Personaliza√ß√£o do Conte√∫do (Substituir placeholders)
            const name = document.getElementById('name').value.trim() || '[Nome do Colaborador]';
            const docId = document.getElementById('documentId').value.trim() || '[RE/RG/CPF]';
            const empresaNome = EMPRESA_MAP[currentEmpresa] || '[Empresa Ativa]';

            // Substitui todos os placeholders no texto do termo
            content = content.replace(/\[Nome do Colaborador\]/g, name);
            content = content.replace(/\[RE\/RG\/CPF\]/g, docId);
            content = content.replace(/\[Empresa Ativa\]/g, empresaNome);

            displayDiv.innerHTML = content;
            displayDiv.classList.add('bg-white', 'border-blue-300');
            displayDiv.classList.remove('bg-gray-50', 'border-gray-300');
        } else {
            displayDiv.innerHTML = 'Selecione um tipo de termo acima para visualizar o conte√∫do.';
            displayDiv.classList.remove('bg-white', 'border-blue-300');
            displayDiv.classList.add('bg-gray-50', 'border-gray-300');
        }
      }

      // ----------------------------------------------------
      // 3. L√ìGICA DO CANVAS (Assinaturas)
      // ----------------------------------------------------

      const canvasState = {};
      const canvases = {};

      function initCanvas(canvasElement) {
        const ctx = canvasElement.getContext('2d');
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#000000';
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, canvasElement.width, canvasElement.height); // Garante fundo branco

        canvasState[canvasElement.id] = {
          drawing: false,
          lastX: 0,
          lastY: 0,
          isSigned: false,
          ctx: ctx
        };

        const state = canvasState[canvasElement.id];
        
        const startDraw = (e) => {
          state.drawing = true;
          state.isSigned = true;
          [state.lastX, state.lastY] = getCoordinates(e, canvasElement);
          e.preventDefault();
        };

        const stopDraw = () => {
          state.drawing = false;
        };

        const draw = (e) => {
          if (!state.drawing) return;
          e.preventDefault();
          const [x, y] = getCoordinates(e, canvasElement);

          state.ctx.beginPath();
          state.ctx.moveTo(state.lastX, state.lastY);
          state.ctx.lineTo(x, y);
          state.ctx.stroke();

          state.lastX = x;
          state.lastY = y;
        };

        const getCoordinates = (e, canvas) => {
            const rect = canvas.getBoundingClientRect();
            let x, y;

            if (e.touches && e.touches.length > 0) { // Touch event
                x = e.touches[0].clientX - rect.left;
                y = e.touches[0].clientY - rect.top;
            } else { // Mouse event
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            }
            return [x, y];
        };


        // Eventos para Mouse
        canvasElement.addEventListener('mousedown', startDraw);
        canvasElement.addEventListener('mouseup', stopDraw);
        canvasElement.addEventListener('mouseout', stopDraw);
        canvasElement.addEventListener('mousemove', draw);

        // Eventos para Touch
        canvasElement.addEventListener('touchstart', startDraw);
        canvasElement.addEventListener('touchend', stopDraw);
        canvasElement.addEventListener('touchcancel', stopDraw);
        canvasElement.addEventListener('touchmove', draw);
      }

      function clearAllCanvases() {
        Object.keys(canvases).forEach(id => {
          const canvas = canvases[id];
          if (canvas) {
            const state = canvasState[id];
            state.ctx.fillRect(0, 0, canvas.width, canvas.height);
            state.isSigned = false;
          }
        });
        document.getElementById('termType').value = '';
        document.getElementById('term-agreement').checked = false;
        updateTermContent();
        displayMessage('Assinaturas e campos limpos. Voc√™ pode come√ßar a desenhar novamente.', false);
      }

      // ----------------------------------------------------
      // 4. L√ìGICA DE PERSIST√äNCIA (Local Storage)
      // ----------------------------------------------------
      
      function getAssinaturas() {
          try {
              const data = localStorage.getItem(LOCAL_STORAGE_KEY);
              // Garante que o status seja 'ativo' se n√£o existir (para compatibilidade com dados antigos)
              const assinaturas = data ? JSON.parse(data) : [];
              return assinaturas.map(item => ({
                  ...item,
                  status: item.status || 'ativo' 
              }));
          } catch (e) {
              console.error("Erro ao ler Local Storage:", e);
              return [];
          }
      }

      function saveAssinaturaData(newAssinatura) {
          const assinaturas = getAssinaturas();
          assinaturas.push(newAssinatura);
          try {
              localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(assinaturas));
              return true;
          } catch (e) {
              console.error("Erro ao escrever Local Storage:", e);
              displayMessage('Erro ao salvar no armazenamento local do navegador. Local Storage cheio ou indispon√≠vel.', true);
              return false;
          }
      }
      
      function updateAssinaturaStatus(id, newStatus) {
          let assinaturas = getAssinaturas();
          const index = assinaturas.findIndex(a => a.id === id);
          
          if (index !== -1) {
              assinaturas[index].status = newStatus;
              
              try {
                  localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(assinaturas));
                  loadAndFilterAssinaturas(); // Recarrega a lista
                  displayMessage(`Status do termo ${id} atualizado para ${newStatus.toUpperCase()}.`, false, 'message-box-consultar');
                  return true;
              } catch (e) {
                  console.error("Erro ao atualizar Local Storage:", e);
                  displayMessage('Erro ao atualizar o status.', true, 'message-box-consultar');
                  return false;
              }
          }
          return false;
      }

      async function saveAssinatura() {
        if (!currentEmpresa) {
            displayMessage('Por favor, selecione uma empresa no in√≠cio.', true);
            return;
        }

        const nameInput = document.getElementById('name').value.trim();
        const docIdInput = document.getElementById('documentId').value.trim();
        const emailInput = document.getElementById('email').value.trim();
        const departmentInput = document.getElementById('department').value;
        const centroCustoInput = document.getElementById('centroCusto').value.trim();
        const termTypeInput = document.getElementById('termType').value;
        const termAgreement = document.getElementById('term-agreement').checked;
        
        const colabCanvasState = canvasState['colaboradorCanvas'];
        const suporteCanvasState = canvasState['suporteCanvas'];

        // 1. Valida√ß√£o de Campos
        if (!nameInput || !docIdInput || !emailInput || !departmentInput || !colabCanvasState.isSigned || !suporteCanvasState.isSigned || !termTypeInput || !termAgreement) {
          displayMessage('Preencha todos os campos obrigat√≥rios (incluindo Tipo de Termo, assinaturas e concord√¢ncia com o termo)!', true, 'message-box');
          return;
        }
        
        // 2. Coleta de Dados
        const assinaturaData = {
          id: Date.now().toString(), // ID simples baseado no timestamp
          name: nameInput,
          documentId: docIdInput,
          email: emailInput,
          department: departmentInput,
          centroCusto: centroCustoInput || 'N/A',
          telefone: document.getElementById('telefone').value.trim() || 'N/A',
          empresa: currentEmpresa,
          termType: termTypeInput, 
          colaboradorSignature: canvases.colaboradorCanvas.toDataURL('image/png'),
          suporteSignature: canvases.suporteCanvas.toDataURL('image/png'),
          status: 'ativo', // Novo termo √© sempre ativo
          createdAt: new Date().toISOString(),
        };
        
        document.getElementById('btn-save').disabled = true;

        // 3. Salvar no Local Storage
        if (saveAssinaturaData(assinaturaData)) {
            displayMessage('Assinatura salva com sucesso no Local Storage!', false, 'message-box');
          
            // Limpar formul√°rio e canvas
            document.getElementById('name').value = '';
            document.getElementById('documentId').value = '';
            document.getElementById('email').value = '';
            document.getElementById('telefone').value = '';
            document.getElementById('centroCusto').value = '';
            clearAllCanvases();
        }

        document.getElementById('btn-save').disabled = false;
      }
      
      function renderAssinaturasList(docs) {
          const listElement = document.getElementById('assinaturas-list');
          listElement.innerHTML = '';
          
          if (docs.length === 0) {
              document.getElementById('empty-state').classList.remove('hidden');
              return;
          }
          
          document.getElementById('empty-state').classList.add('hidden');
          
          docs.forEach(data => {
              const listItem = document.createElement('div');
              const isActive = data.status === 'ativo';
              
              listItem.className = `term-item ${isActive ? '' : 'inactive'} bg-white p-4 sm:p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-200 border border-gray-100`;
              
              const dateObj = new Date(data.createdAt);
              const formattedDate = dateObj.toLocaleDateString('pt-BR') + ' ' + dateObj.toLocaleTimeString('pt-BR');
              
              const termBadge = TERM_MAP[data.termType] ? 
                  `<span class="text-xs font-semibold px-3 py-1 rounded-full bg-blue-100 text-blue-700 mr-2">${TERM_MAP[data.termType].toUpperCase()}</span>` : 
                  '';
                  
              const statusBadge = isActive ? 
                  `<span class="text-xs font-semibold px-3 py-1 rounded-full bg-green-100 text-green-700">ATIVO</span>` : 
                  `<span class="text-xs font-semibold px-3 py-1 rounded-full bg-red-100 text-red-700">DESATIVADO</span>`;

              const actionButton = isActive ? 
                  `<button data-id="${data.id}" data-action="desativar" class="btn-status-action text-red-600 hover:text-red-800 font-medium text-sm transition-colors duration-150 ml-4">Desativar</button>` :
                  `<button data-id="${data.id}" data-action="ativar" class="btn-status-action text-green-600 hover:text-green-800 font-medium text-sm transition-colors duration-150 ml-4">Reativar</button>`;


              listItem.innerHTML = `
                  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-3 mb-3">
                      <h3 class="text-lg font-bold text-gray-800">${data.name}</h3>
                      <div class="mt-2 sm:mt-0 flex items-center">
                          ${termBadge}
                          ${statusBadge}
                      </div>
                  </div>
                  <div class="text-sm text-gray-600 grid grid-cols-1 sm:grid-cols-2 gap-2">
                      <p><strong>Documento:</strong> ${data.documentId}</p>
                      <p><strong>Email:</strong> ${data.email}</p>
                      <p><strong>Departamento:</strong> ${DEPARTMENT_MAP[data.department] || data.department}</p>
                      <p><strong>C. Custo:</strong> ${data.centroCusto}</p>
                      <p class="sm:col-span-2"><strong>Data:</strong> ${formattedDate}</p>
                  </div>
                  <div class="mt-4 pt-4 border-t border-gray-100 flex justify-between items-center">
                    <button
                        data-colab-sig="${data.colaboradorSignature}"
                        data-suporte-sig="${data.suporteSignature}"
                        data-name="${data.name}"
                        class="btn-view-signature text-blue-600 hover:text-blue-800 font-medium text-sm transition-colors duration-150"
                    >
                        Ver Assinaturas
                    </button>
                    ${actionButton}
                  </div>
              `;
              listElement.appendChild(listItem);
          });
          
          document.querySelectorAll('.btn-view-signature').forEach(button => {
            button.addEventListener('click', (e) => {
                const colabSig = e.target.getAttribute('data-colab-sig');
                const suporteSig = e.target.getAttribute('data-suporte-sig');
                const name = e.target.getAttribute('data-name');
                showSignatureModal(colabSig, suporteSig, name);
            });
          });
          
          document.querySelectorAll('.btn-status-action').forEach(button => {
              button.addEventListener('click', (e) => {
                  const id = e.target.getAttribute('data-id');
                  const action = e.target.getAttribute('data-action');
                  const newStatus = action === 'ativar' ? 'ativo' : 'desativado';
                  updateAssinaturaStatus(id, newStatus);
              });
          });
      }

      function loadAndFilterAssinaturas() {
        const allAssinaturas = getAssinaturas();

        const searchTerm = document.getElementById('search-term').value.trim().toLowerCase();
        const filterDept = document.getElementById('filter-department').value;
        // O filtro de status agora √© determinado pelo estado da sub-aba (currentViewStatus)
        const filterStatus = currentViewStatus; 
        
        let filteredDocs = allAssinaturas.filter(data => {
            // 1. Filtrar por Empresa (autom√°tico)
            if (data.empresa !== currentEmpresa) {
                return false;
            }
            
            // 2. Filtrar por Status (Usando o estado da sub-aba)
            if (data.status !== filterStatus) {
                return false;
            }

            // 3. Filtrar por Departamento
            if (filterDept !== 'todos' && data.department !== filterDept) {
                return false;
            }
            
            // 4. Filtrar por Termo de Busca (Nome ou Documento)
            if (searchTerm) {
                const nameMatch = data.name.toLowerCase().includes(searchTerm);
                const docIdMatch = data.documentId.toLowerCase().includes(searchTerm);
                if (!nameMatch && !docIdMatch) {
                    return false;
                }
            }
            
            return true;
        });
        
        // Simula√ß√£o de ordena√ß√£o por data de cria√ß√£o (mais recente primeiro)
        filteredDocs.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        
        renderAssinaturasList(filteredDocs);
      }

      // ----------------------------------------------------
      // 5. MODAL DE ASSINATURAS DETALHADAS
      // ----------------------------------------------------

      function showSignatureModal(colabSig, suporteSig, name) {
        // Cria o modal dinamicamente para n√£o poluir o HTML inicial
        let modal = document.getElementById('signature-detail-modal');
        if (!modal) {
          modal = document.createElement('div');
          modal.id = 'signature-detail-modal';
          modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-80 transition-opacity duration-300';
          modal.innerHTML = `
              <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg mx-4 transform scale-95 transition-transform duration-300">
                  <h3 id="modal-title" class="text-xl font-bold text-gray-800 border-b pb-2 mb-4">Assinaturas</h3>
                  
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div>
                          <p class="text-sm font-medium text-gray-600 mb-2">Assinatura Colaborador:</p>
                          <img id="colab-img" src="" alt="Assinatura do Colaborador" class="w-full border rounded-lg p-2 bg-gray-50"/>
                      </div>
                      <div>
                          <p class="text-sm font-medium text-gray-600 mb-2">Assinatura Suporte:</p>
                          <img id="suporte-img" src="" alt="Assinatura do Suporte" class="w-full border rounded-lg p-2 bg-gray-50"/>
                      </div>
                  </div>
                  
                  <button id="close-detail-modal" class="w-full mt-6 px-6 py-3 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition-colors">Fechar</button>
              </div>
          `;
          document.body.appendChild(modal);
          
          document.getElementById('close-detail-modal').addEventListener('click', () => {
              modal.classList.remove('active');
          });
          // Permite fechar clicando fora do conte√∫do
          modal.addEventListener('click', (e) => {
             if (e.target === modal) {
                 modal.classList.remove('active');
             }
          });
        }
        
        document.getElementById('modal-title').textContent = `Assinaturas de ${name}`;
        document.getElementById('colab-img').src = colabSig;
        document.getElementById('suporte-img').src = suporteSig;
        modal.classList.add('active'); // Usa a classe active para mostrar/esconder
      }

      // ----------------------------------------------------
      // 6. L√ìGICA DO MODAL DE EMPRESA
      // ----------------------------------------------------
      
      function handleModalContinue() {
        const select = document.getElementById('empresa-modal-select');
        const messageBox = document.getElementById('modal-message-box');
        currentEmpresa = select.value;

        if (!currentEmpresa) {
          messageBox.textContent = 'Por favor, selecione uma empresa para continuar.';
          messageBox.classList.remove('hidden');
          return;
        }

        messageBox.classList.add('hidden');
        document.getElementById('empresa-modal').style.display = 'none';
        document.getElementById('main-app-container').style.display = 'block';
        
        // Salva a empresa selecionada no Local Storage
        localStorage.setItem('current_empresa', currentEmpresa);
        
        // Atualiza a UI principal com a empresa selecionada
        const empresaNome = EMPRESA_MAP[currentEmpresa] || currentEmpresa;
        document.getElementById('current-empresa-name').textContent = empresaNome;
        
        // Preenche o campo Empresa na aba de Assinatura
        const mainEmpresaSelect = document.getElementById('empresa');
        mainEmpresaSelect.innerHTML = `<option value="${currentEmpresa}">${empresaNome}</option>`;
        
        // Preenche o campo Empresa na aba de Consulta (somente o valor atual)
        const filterEmpresaSelect = document.getElementById('filter-empresa');
        filterEmpresaSelect.innerHTML = `<option value="${currentEmpresa}">${empresaNome}</option>`;

        // Se a aba de consulta for a ativa, carrega e filtra os dados.
        if (document.getElementById('tab-consultar').classList.contains('active')) {
            loadAndFilterAssinaturas();
        }
        // Atualiza o termo na aba de Assinatura
        updateTermContent();
      }

      // ----------------------------------------------------
      // 7. EVENT LISTENERS
      // ----------------------------------------------------

      window.onload = () => {
        // 1. Inicializa√ß√£o do Canvas
        canvases.colaboradorCanvas = document.getElementById('colaboradorCanvas');
        canvases.suporteCanvas = document.getElementById('suporteCanvas');
        initCanvas(canvases.colaboradorCanvas);
        initCanvas(canvases.suporteCanvas);

        // Tenta carregar a empresa salva
        const savedEmpresa = localStorage.getItem('current_empresa');
        if (savedEmpresa && EMPRESA_MAP[savedEmpresa]) {
            currentEmpresa = savedEmpresa;
            document.getElementById('empresa-modal-select').value = savedEmpresa;
            handleModalContinue();
        } else {
            // Se n√£o houver empresa salva, exibe o modal
            document.getElementById('empresa-modal').style.display = 'flex';
        }

        // 2. Bot√£o Continuar do Modal
        document.getElementById('btn-continuar').addEventListener('click', handleModalContinue);
        
        // 3. Bot√µes de A√ß√£o na aba Assinar
        document.getElementById('btn-save').addEventListener('click', saveAssinatura);
        document.getElementById('btn-clear').addEventListener('click', clearAllCanvases);

        // 4. Navega√ß√£o por Abas Principais
        document.getElementById('btn-tab-assinar').addEventListener('click', () => switchTab('assinar'));
        document.getElementById('btn-tab-consultar').addEventListener('click', () => switchTab('consultar'));
        
        // 5. Navega√ß√£o por Sub-abas (Ativos/Desativados)
        document.getElementById('btn-status-ativo').addEventListener('click', () => switchStatusView('ativo'));
        document.getElementById('btn-status-desativado').addEventListener('click', () => switchStatusView('desativado'));

        // 6. Atualiza√ß√£o e Valida√ß√£o do Termo
        document.getElementById('termType').addEventListener('change', updateTermContent);
        document.getElementById('name').addEventListener('input', updateTermContent);
        document.getElementById('documentId').addEventListener('input', updateTermContent);

        // 7. Filtros e Busca na aba Consultar
        const updateFilterAndSearch = () => {
            loadAndFilterAssinaturas();
        };

        // Aplica o debounce para a busca por texto
        let searchTimeout;
        document.getElementById('search-term').addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(updateFilterAndSearch, 300); // Espera 300ms antes de filtrar
        });

        // Aplica filtro imediatamente para dropdowns
        document.getElementById('filter-department').addEventListener('change', updateFilterAndSearch);

        // Garante que a primeira tab principal e a primeira sub-tab estejam ativas ao carregar
        switchTab('assinar');
        switchStatusView('ativo');
      };

    </script>
  </body>
</html>
